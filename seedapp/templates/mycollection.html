# Seeds of Diversity Seed Collection Manager templates

%% mycollStyle
<style>
</style>


%% mycollForms
<div id='consolePageStart' class='consolePage'>
<h3>New Accession</h3>
<form>
<div class='well myc-section'>Are these seeds regenerated from our collection?</div>
<p>If these seeds were regrown from our collection:</p>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Enter parent inventory number</div>
    <div class='col-sm-6'>[[formtext: slinv]]</div>
</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-10'><hr style='border-color:#ccc'/></div>
</div>    
<p>If these seeds are new to our collection:</p>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Search for the cultivar name</div>
    <div class='col-sm-6'>
        <span id='cultivarText' style='font-size:9pt'>[[Value:P_psp]] : [[Value:P_name]] ([[Value:P__key]])</span>
        [[text:dummy_pcv | size:10 class:SFU_TextComplete | placeholder='Search']]
        [[hidden:fk_sl_pcv|class:cpvar_fk_sl_pcv]]
        <select class='SFUAC_Select'></select>
    </div>
</div>
<div class='row' style='margin-top:5px'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>If the original name is different than the 'primary' cultivar name above, record it here</div>
    <div class='col-sm-6'>[[formtext:oname | class:cpvar_oname]]</div>
</div>
<p>&nbsp;</p>
<div class='well myc-section'>What is the total weight of the seeds?</div>
<div class='row'>
    <div class='col-sm-6'></div>
    <div class='col-sm-6'>[[formtext:gtotal | class:cpvar_gtotal]] grams</div>
</div>
<input type='submit' value='Next'/>
</form></div>


<div id='consolePagePop100' class='consolePage' style='display:none'>
<h3>New Accession</h3>
<form>
<p>You have <span class='cpvar_gtotal'></span> grams of <span class='cpvar_oname'></span>.</p> 
<div class='well myc-section'>Please count out 100 seeds and weigh them. This helps us calculate how many seeds we're storing.</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>100 seeds weigh </div>
    <div class='col-sm-6'>[[formtext:g100 | class:cpvar_g100]] grams</div>
</div>
<p>&nbsp;</p>
<div class='well myc-section'>How many of these seeds make a minimum population? Take germination rate into account if you know it.</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>A population needs </div>
    <div class='col-sm-6'>[[formtext:pop | class:cpvar_pop]] seeds</div>
</div>
<input type='submit' value='Next'/>
</form></div>


<div id='consolePageActions' class='consolePage' style='display:none'>
<h3>New Accession</h3>
<p>You have <span class='cpvar_gtotal'></span> grams of <span class='cpvar_oname'></span>.</p> 
<p>100 seeds weigh <span class='cpvar_g100'></span> grams.</p>
<p><span class='cpvar_pop'></span> seeds make a minimal population.</p> 

<form>
<div class='well myc-section'>Now decide where to put the seeds. Based on <span class='cpvar_gtotal'></span> grams weight and <span class='cpvar_g100'></span> grams per 100 seeds, you can:</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Do a germination test</div>
    <div class='col-sm-6'>[[formtext:nSeedsGerm | class:cpvar_nSeedsGerm]] seeds (X grams)</div>
</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Put some seeds in frozen storage</div>
    <div class='col-sm-6'>[[formtext:nPopI1 | class:cpvar_nPopI2]] populations (X grams)</div>
</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Donate some seeds to PGRC</div>
    <div class='col-sm-6'>[[formtext:nPopPGRC | class:cpvar_nPopPGRC]] populations (X grams)</div>
</div>
<div class='row'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Put the rest in working storage</div>
    <div class='col-sm-6'>P populations (X grams)</div>
</div>
<input type='submit' value='Next'/>
</form></div>


<div id='consolePageSupplier' class='consolePage' style='display:none'>
<h3>New Accession</h3>
<p>You have <span class='cpvar_gtotal'></span> grams of <span class='cpvar_oname'></span>.</p> 
<p>100 seeds weigh <span class='cpvar_g100'></span> grams.</p>
<p><span class='cpvar_pop'></span> seeds make a minimal population.</p> 

<form>
<div class='well myc-section'>Which boxes/jars will you put the seeds in?</div>
<div class='row'>
    <div class='col-sm-6'></div>
    <div class='col-sm-6'>Enter location:</div>
</div>
<div class='row'>
    <div class='col-sm-2'>Inventory # <span class='cpvar_slinv1'></span></div>
    <div class='col-sm-4'>Working storage is <span class='cpvar_gI1'></span> grams</div>
    <div class='col-sm-6'>[[formtext:locI1 | class:cpvar_locI1]]</div>
</div>
<div class='row'>
    <div class='col-sm-2'>Inventory # <span class='cpvar_slinv2'></span></div>
    <div class='col-sm-4'><span class='cpvar_nPopI2'></span> populations to frozen storage (<span class='cpvar_nSeedsI2'></span> seeds) = <span class='cpvar_gI2'></span> grams</div>
    <div class='col-sm-6'>[[formtext:locI2 | class:cpvar_locI2]]</div>
</div>
<div class='row'>
    <div class='col-sm-2'>Mark # <span class='cpvar_slinv1'></span></div>
    <div class='col-sm-4'><span class='cpvar_nPopPGRC'></span> populations to PGRC (<span class='cpvar_nSeedsPGRC'></span> seeds) = <span class='cpvar_gPGRC'></span> grams</div>
    <div class='col-sm-6'></div>
</div>
<div class='row'>
    <div class='col-sm-2'>Mark # <span class='cpvar_slinv1'></span></div>
    <div class='col-sm-4'><span class='cpvar_nSeedsGerm'></span> seeds for germination test</div>
    <div class='col-sm-6'></div>
</div>

<div class='well myc-section'>Who provided these seeds?</div>
<div class='row' style='margin-top:5px'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Seeds grown by a Seeds of Diversity member</div>
    <div class='col-sm-6'>[[formtext:_supplierSoD | class:cpvar_supplierSoD]] Search</div>
</div>
<div class='row' style='margin-top:5px'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Seeds purchased from a seed company</div>
    <div class='col-sm-6'>[[formtext:supplierCmp | class:cpvar_supplierCmp]] Search</div>
</div>
<div class='row' style='margin-top:5px'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Seeds obtained from elsewhere</div>
    <div class='col-sm-6'>[[formtext:supplierOther | class:cpvar_supplierOther]] Enter source</div>
</div>
<hr style='border-color:#ccc'/>
<div class='row' style='margin-top:5px'>
    <div class='col-sm-2'></div>
    <div class='col-sm-4'>Year that the seeds were grown or purchased</div>
    <div class='col-sm-6'>[[formtext:year | class:cpvar_year]]</div>
</div>

<input type='submit' value='Next'/>
</form>
</div>


<div id='consolePageConfirm' class='consolePage' style='display:none'>
<form>
<p>Saved</p>
<div>Working storage : Inventory # I : X grams : Location <span class='cpvar_name'></span></div>
<div>Frozen storage : Inventory # I2 (or none) : X grams : Location <span class='cpvar_name'></span></div>
<div>PGRC : Marked as # I (or none) : X grams <span class='cpvar_name'></span></div>
<div>Germination test : PGRC : Marked as # I (or none) : N seeds <span class='cpvar_name'></span></div>

<div>Your cat is <span class='cpvar_cat'></span></div>
<input type='submit'/>
</form>
</div>


<script>
var config = {
        pages: {
            Start: {
                 model: 'LoadStore',
                 fnPre: function() {},
                 fnPost: function() { console.log('foo');
                     return( 'Pop100' );
                 }
               },
            Pop100: {
                 model: 'LoadStore',
                 fnPre: function() {},
                 fnPost: function() {
                     return( 'Actions' );
                 }
               },
            Actions: {
                 model: 'LoadStore',
                 fnPre: function() {},
                 fnPost: function() {
                     finalReport();
                     return( 'Supplier' );
                 }
               },
            Supplier: {
                 model: 'LoadStore',
                 fnPre: function() {},
                 fnPost: function() {
                     finalReport();
                     return( 'Confirm' );
                 }
               },
             Confirm: {
                 model: 'LoadStore',
                 fnPre: function() {},
                 fnPost: function() {
                     finalReport();
                     return( 'Confirm' );
                 },
               }
        }
};

var oCP = new ConsolePage( config );
oCP.Ready();

function finalReport()
{
    alert( 'You are '+oCP.GetVar('name')+' and your cat is '+oCP.GetVar('cat') );
}

</script>

<script>

$(document).ready( function() { 

    // don't set up the autocomplete if there isn't one - offset().left below causes a js error that kills other ready() functions
    if( typeof $('.SFU_TextComplete').offset() == 'undefined' )  return;

    // Set up the AutoComplete select box
    //     Show Select on focus, and hide it when a value is selected.
    //     Except, it's nice to be able to hide Select without choosing a value.
    //     Select.hide on AutoComplete.blur didn't work because the Select doesn't receive the click.
    //     You can use a complex combination of focus and mousedown, but it's complex.
    //     Select.toggle on AutoComplete.click is great, except that you can't activate the Select by obtaining focus via tab key.
    //         In a complicated screen you won't do that much anyway.      

//keyup
    $('.SFU_TextComplete').click( function(e){ 

        let oTC = $(this);   // preserve $this in the closure below
        
        let select = $(this).siblings('.SFUACSelect');
        // Create and position the select control if it doesn't exist 
        if( !select.length ) {
            select = $("<select class='SFUACSelect'><option>Foo</option></select>").insertAfter($(this));

            let xSearch = $(this).offset().left;
            let ySearch = $(this).offset().top;
            let hSearch = $(this).outerHeight();
            let xAnchor = $(this).parent().offset().left;
            let yAnchor = $(this).parent().offset().top;
            select.css({ position:'absolute', left:xSearch-xAnchor, top:ySearch-yAnchor+hSearch+1, 'z-index':2 });
            
            select.click( function(e){ e.preventDefault(); oTC.val( $(this).val() ); $(this).remove(); }); //SEEDFormUIAutoComplete_SelectClick2(); $('.SFUAC_Select').hide();});
        }
        
//            $('.SFUAC_Select').toggle();

            /* Position the Select just below the Search box. The right way seems to be absolute positioning with top and left
             * calculated using the Search Box. But absolute positions are relative to the closest positioned (e.g. position:relative) ancestor.
             * That means you have to set some ancestor to 
             *
             *     style='position:relative' class='SFUAC_Anchor'
             *
             * so we can find the Search box in static coordinates and compute its location relative to the Anchor, then position the Select 
             * relative to that Anchor.
             */
            var xSearch = $('.SFU_TextComplete').offset().left;
            var ySearch = $('.SFU_TextComplete').offset().top;
            var hSearch = $('.SFU_TextComplete').outerHeight();
            var xAnchor = $('.SFUAC_Anchor').offset().left;
            var yAnchor = $('.SFUAC_Anchor').offset().top;
            $('.SFUAC_Select').css({ left:xSearch-xAnchor, top:ySearch+hSearch-yAnchor });
        });
    $('.SFUAC_Select').click( function(e){ e.preventDefault(); SEEDFormUIAutoComplete_SelectClick2(); $('.SFUAC_Select').hide();});
    $('.SFUAC_Select').css({ display:'none', 
                             position:'absolute'
                           });
    $('.SFUAC_Select').attr({ size:$('.SFUAC_Select option').length }); 
    
    $('.SFU_TextComplete').keyup( function(e){ SEEDFormUIAutoComplete_Change2(); });
    
});

var SEEDFormUIParms2 = { urlQ : "https://www.seeds.ca/app/q/index.php" };
//var SEEDFormUIParms = { urlQ : "http://localhost/seedsCurr/seeds.ca2/app/q/index.php" };

function SEEDFormUIAutoComplete_Change2()
{
    var urlQ = SEEDFormUIParms2['urlQ']; // ajax request to authenticate parameters
    var sSearch = $(".SFU_TextComplete").val();  //var formData = $(".SFU_TextComplete").serialize();alert(formData);

    // don't bother searching unless the user has typed at least 3 chars
    if( sSearch.length < 3 )  return;
    //if( !sSearch )  return;
    
    jxData = { cmd : 'rosettaPCVSearch',
               lang : "EN",
               srch : sSearch
             };

// extend SEEDJX to take a function ( o ) that is called on async completion 
    var o = SEEDJX( urlQ, jxData );

    if( !o ) {
        alert( "Sorry there is a server problem" );
    } else {
        //var bOk = o['bOk'];
        //var sOut = o['sOut'];
        var raOut = o['raOut'];
        
        $(".SFUAC_Select option").each(function() {
            $(this).remove();
        });

        c = raOut.length;
        if( c > 20 ) c = 20;
        for( var i = 0; i < c; ++i ) {
            var r = raOut[i];
// because json can't transmit cp1252 special chars, only utf8 - another reason to make everything utf8         
//          if( r['P_name']==null ) { r['P_name'] = r['P_name_utf8']; } obsolete, no longer sent
            $('.SFUAC_Select').append($('<option>', { value: r['P__key'], text: r['S_psp']+" : "+r['P_name']+" ("+r['P__key']+")" }) );
        }
    }

    // make the select control tall enough to contain all options
    $('.SFUAC_Select').attr({ size:$('.SFUAC_Select option').length }); 
}


function SEEDFormUIAutoComplete_SelectClick2()
{
    var sel = $(".SFUAC_Select").val();
    
    $("#cultivarText").html( $('.SFUAC_Select option:selected').text() );
    $("#sfAp_fk_sl_pcv").val(sel);
}

</script>

